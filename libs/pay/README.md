# üí≥ M√≥dulo Pay - Documentaci√≥n T√©cnica

## üéØ Descripci√≥n General

El m√≥dulo **Pay** gestiona el ciclo completo de **√≥rdenes** y **pagos** del sistema. Provee CRUD, estados, validaciones de negocio, eventos de dominio, operaciones en lote y auditor√≠a. Integra con otros m√≥dulos (p. ej. Billing) mediante generadores de √≥rdenes y con auditor√≠a del sistema para trazabilidad.

## üèóÔ∏è Arquitectura del M√≥dulo

### Estructura de Directorios
```
üìÅ libs/pay/
‚îú‚îÄ‚îÄ üìÅ controllers/                 # Controladores REST (Order y Payment)
‚îú‚îÄ‚îÄ üìÅ entities/                    # Entidades (Swagger models)
‚îú‚îÄ‚îÄ üìÅ errors/                      # Mensajes de error
‚îú‚îÄ‚îÄ üìÅ events/                      # Eventos de dominio (OrderEvents)
‚îú‚îÄ‚îÄ üìÅ generators/                  # Generadores base de √≥rdenes
‚îú‚îÄ‚îÄ üìÅ interfaces/                  # Tipados, enums y DTOs
‚îú‚îÄ‚îÄ üìÅ repositories/                # Acceso a datos (PayBaseRepository)
‚îú‚îÄ‚îÄ üìÅ services/                    # L√≥gica de negocio (OrderService, PaymentService)
‚îú‚îÄ‚îÄ üìÅ use-cases/                   # Casos de uso (ordenes y pagos)
‚îú‚îÄ‚îÄ üìÅ utils/                       # Utilidades (c√°lculos de pagos)
‚îú‚îÄ‚îÄ pay.module.ts                   # Configuraci√≥n del m√≥dulo
‚îî‚îÄ‚îÄ README.md                       # Esta documentaci√≥n
```

### Patr√≥n Arquitect√≥nico
- Clean Architecture + Repository Pattern
- Casos de uso por operaci√≥n (crear, actualizar, cancelar, reembolsar, etc.)
- Auditor√≠a con `AuditModule`
- Enums y DTOs fuertemente tipados (TypeScript)
- Event-Driven con `@nestjs/event-emitter`

## üîß Dependencias del M√≥dulo

### Internas
```typescript
@Module({
  imports: [AuditModule],
  controllers: [OrderController, PaymentController],
  providers: [
    // Services
    OrderService,
    PaymentService,
    // Repositories
    OrderRepository,
    PaymentRepository,
    // Use cases - Orders
    CreateOrderUseCase,
    UpdateOrderUseCase,
    DeleteOrdersUseCase,
    ReactivateOrdersUseCase,
    FindOrdersByStatusUseCase,
    SubmitDraftOrderUseCase,
    CompleteOrderUseCase,
    CancelOrderUseCase,
    RefundOrderUseCase,
    // Use cases - Payments
    CreatePaymentUseCase,
    UpdatePaymentUseCase,
    DeletePaymentsUseCase,
    ReactivatePaymentsUseCase,
    ProcessPaymentUseCase,
    VerifyPaymentUseCase,
    RejectPaymentUseCase,
    CancelPaymentUseCase,
    FindPaymentsByStatusUseCase,
    RefundPaymentUseCase,
  ],
  exports: [OrderService, PaymentService, OrderRepository, PaymentRepository],
})
```

### Externas
- `@nestjs/common`, `@nestjs/swagger`
- `@nestjs/event-emitter`
- `class-validator`, `class-transformer`
- `@prisma/client` (v√≠a `PrismaService`)

## üìä Modelos de Datos y Enums

### Entidad: `Order`
Campos clave: `id`, `code`, `type`, `movementTypeId`, `referenceId`, `sourceId`, `targetId`, `status`, `currency`, `subtotal`, `tax`, `total`, `date`, `notes`, `metadata`, `isActive`.

- `OrderType`: `MEDICAL_PRESCRIPTION_ORDER`, `MEDICAL_APPOINTMENT_ORDER`, `PRODUCT_SALE_ORDER`, `PRODUCT_PURCHASE_ORDER`
- `OrderStatus`: `DRAFT`, `PENDING`, `PROCESSING`, `COMPLETED`, `CANCELLED`, `REFUNDED`, `REQUIRES_ATTENTION`

Extensiones:
- `DetailedOrder`: `Order` + `payments: Payment[]`
- `AppointmentOrder`, `ProductSaleOrder`, `PrescriptionOrder`: tipan `metadata` seg√∫n metadatos del m√≥dulo Billing

### Entidad: `Payment`
Campos: `id`, `orderId`, `date`, `status`, `type`, `amount`, `description`, `paymentMethod`, `voucherNumber`, `verifiedBy`, `verifiedAt`, `isActive`, `createdAt`, `updatedAt`.

- `PaymentStatus`: `PENDING`, `PROCESSING`, `COMPLETED`, `CANCELLED`, `REFUNDED`
- `PaymentType`: `REGULAR`, `REFUND`, `PARTIAL_PAYMENT`, `ADJUSTMENT`, `COMPENSATION`
- `PaymentMethod`: `CASH`, `BANK_TRANSFER`, `DIGITAL_WALLET`

## üßæ Tipados (Interfaces, Enums y DTOs)

### Interfaces base

Origen: `libs/pay/src/interfaces/order.interface.ts`

```typescript
export interface IOrder {
  code?: string;
  type: OrderType;
  movementTypeId: string;
  referenceId: string;
  sourceId?: string;
  targetId?: string;
  status: OrderStatus;
  currency: string;
  subtotal: number;
  tax: number;
  total: number;
  date: Date;
  dueDate?: Date;
  notes?: string;
  metadata?: string; // JSON stringificado
}

export interface IOrderGenerator {
  type: OrderType;
  canHandle(type: OrderType): boolean;
  generate(input: any): Promise<IOrder>;
  calculateTotal(input: any): Promise<number>;
  calculateTax(subtotal: number): Promise<number>;
}
```

### Enums

Origen: `libs/pay/src/interfaces/order.types.ts`, `libs/pay/src/interfaces/payment.types.ts`

```typescript
// Order
export enum OrderStatus {
  DRAFT = 'DRAFT', PENDING = 'PENDING', PROCESSING = 'PROCESSING',
  COMPLETED = 'COMPLETED', CANCELLED = 'CANCELLED', REFUNDED = 'REFUNDED',
  REQUIRES_ATTENTION = 'REQUIRES_ATTENTION',
}
export enum OrderType {
  MEDICAL_PRESCRIPTION_ORDER = 'MEDICAL_PRESCRIPTION_ORDER',
  MEDICAL_APPOINTMENT_ORDER = 'MEDICAL_APPOINTMENT_ORDER',
  PRODUCT_SALE_ORDER = 'PRODUCT_SALE_ORDER',
  PRODUCT_PURCHASE_ORDER = 'PRODUCT_PURCHASE_ORDER',
}

// Payment
export enum PaymentStatus { PENDING, PROCESSING, COMPLETED, CANCELLED, REFUNDED }
export enum PaymentMethod { CASH, BANK_TRANSFER, DIGITAL_WALLET }
export enum PaymentType { REGULAR, REFUND, PARTIAL_PAYMENT, ADJUSTMENT, COMPENSATION }
```

### DTOs - Ordenes

Origen: `libs/pay/src/interfaces/dto/order/*.ts`

```typescript
// create-order.dto.ts
export class CreateOrderDto {
  code?: string; type: OrderType; movementTypeId: string; referenceId: string;
  sourceId?: string; targetId?: string; status: OrderStatus; currency: string;
  subtotal: number; tax: number; total: number; notes?: string; metadata?: string;
}

// update-order.dto.ts
export class UpdateOrderDto extends PartialType(CreateOrderDto) {}

// delete-order.dto.ts
export class DeleteOrdersDto { ids: string[] }

// submit-draft-order.dto.ts
export class SubmitDraftOrderDto { notes?: string }
```

### DTOs - Pagos

Origen: `libs/pay/src/interfaces/dto/payment/*.ts`

```typescript
export class CreatePaymentDto {
  orderId: string; date?: Date; status?: PaymentStatus; type: PaymentType;
  amount: number; description?: string; paymentMethod?: PaymentMethod;
  voucherNumber?: string; originalPaymentId?: string;
}

export class UpdatePaymentDto extends PartialType(CreatePaymentDto) {
  status: PaymentStatus; amount?: number; description?: string;
}

export class DeletePaymentsDto { ids: string[] }
export class ProcessPaymentDto {
  paymentMethod: PaymentMethod; amount: number; voucherNumber?: string; date: Date; description?: string;
}
export class VerifyPaymentDto { verificationNotes?: string; verifiedAt?: Date }
export class RejectPaymentDto { rejectionReason: string }
export class CancelPaymentDto { cancellationReason: string }
export class RefundPaymentDto {
  amount: number; reason: string; refundMethod: PaymentMethod; notes?: string;
}
```

### Entidades (Swagger Models)

Origen: `libs/pay/src/entities/*.ts`

```typescript
class Order { id: string; code?: string; type: OrderType; status: OrderStatus; currency: string;
  subtotal: number; tax: number; total: number; date: Date; notes?: string; metadata?: string; isActive: boolean; }
class DetailedOrder extends Order { payments: Payment[] }
class Payment { id: string; orderId: string; date: Date; status: PaymentStatus; type: PaymentType; amount: number;
  paymentMethod?: PaymentMethod; voucherNumber?: string; verifiedBy?: string; verifiedAt?: Date; isActive: boolean }
```

### Tipos de metadatos (integraci√≥n con Billing)

Origen: `src/modules/billing/interfaces/metadata.interfaces.ts`

```typescript
// Metadata tipada seg√∫n el tipo de orden
type MedicalAppointmentMetadata = { /* patientDetails, orderDetails, transactionDetails */ };
type ProductSaleMetadata = { /* patientDetails, products, transactionDetails */ };
type MedicalPrescriptionMetadata = { /* products, services, transactionDetails */ };
```

## üß± Repositories y Acceso a Datos

### `PayBaseRepository<T>`
- Extiende `BaseRepository<T>` y ajusta mapping de enums `OrderType`/`OrderStatus`
- Serializa `metadata`, `details`, `services` a JSON string
- Helpers: `findByPaymentStatus`, `findByOrderType`, `findByReference`

### `OrderRepository` y `PaymentRepository`
- CRUD, soft-delete/reactivate en lote, `findManyActive`
- `PaymentRepository.findByStatus(status)` y `OrderRepository` con includes para `payments`

Todas las operaciones cr√≠ticas usan `transaction(...)` con auditor√≠a.

## üß† Generadores de √ìrdenes

### `BaseOrderGenerator`
- Contrato para generadores: `type`, `canHandle`, `generate`, `calculateTotal`, `calculateTax`, `calculateTotals`, `generateCode`
- Se registran desde otros m√≥dulos (p.ej. Billing) en `OrderService.registerGenerator(...)`

Uso t√≠pico (desde Billing): generar orden para cita/receta/venta y registrar el generador en `OrderService`.

## üöÄ Casos de Uso

### √ìrdenes
- `CreateOrderUseCase` ‚Äî Crea orden (DRAFT/PENDING...), audita
- `UpdateOrderUseCase` ‚Äî Actualiza datos de orden, audita
- `DeleteOrdersUseCase` ‚Äî Soft delete en lote, audita
- `ReactivateOrdersUseCase` ‚Äî Reactiva en lote, audita
- `FindOrdersByStatusUseCase` ‚Äî Lista por estado
- `SubmitDraftOrderUseCase` ‚Äî DRAFT ‚Üí PENDING, crea pago PENDING asociado
- `CompleteOrderUseCase` ‚Äî COMPLETED + emite eventos por tipo
- `CancelOrderUseCase` ‚Äî CANCELLED + cancela pagos PENDING/PROCESSING + evento
- `RefundOrderUseCase` ‚Äî REFUNDED + marca pagos COMPLETED como REFUNDED + evento

### Pagos
- `CreatePaymentUseCase` ‚Äî Crea pago (por defecto PENDING), audita
- `UpdatePaymentUseCase` ‚Äî Actualiza parcial (monto, estado, descripci√≥n), audita
- `DeletePaymentsUseCase` ‚Äî Soft delete en lote, audita
- `ReactivatePaymentsUseCase` ‚Äî Reactiva en lote, audita
- `ProcessPaymentUseCase` ‚Äî Valida m√©todo/comprobante/montos, pasa a PROCESSING
- `VerifyPaymentUseCase` ‚Äî PROCESSING ‚Üí COMPLETED, actualiza orden a COMPLETED + evento
- `RejectPaymentUseCase` ‚Äî PROCESSING ‚Üí CANCELLED, orden ‚Üí CANCELLED + evento
- `CancelPaymentUseCase` ‚Äî PENDING ‚Üí CANCELLED, orden ‚Üí CANCELLED + evento
- `RefundPaymentUseCase` ‚Äî Crea registro REFUND (monto negativo), orden ‚Üí REFUNDED
- `FindPaymentsByStatusUseCase` ‚Äî Filtro por `status` y opcional `type`, retorna estad√≠sticas por tipo

## üì° Endpoints API

### Ordenes (`/api/v1/order`)
- `POST /` ‚Äî Crear orden ‚Äî Body: `CreateOrderDto` ‚Äî Respuesta: `BaseApiResponse<Order>`
- `GET /` ‚Äî Listar (filtra por sucursal seg√∫n usuario) ‚Äî Respuesta: `DetailedOrder[]`
- `GET /active` ‚Äî Listar activas ‚Äî Respuesta: `Order[]`
- `GET /type/:type` ‚Äî Listar por tipo ‚Äî Respuesta: `Order[]`
- `GET /status/:status` ‚Äî Listar por estado ‚Äî Respuesta: `Order[]`
- `GET /detailed/:id` ‚Äî Obtener detallada por id ‚Äî Respuesta: `DetailedOrder`
- `GET /detailed/code/:code` ‚Äî Obtener detallada por c√≥digo ‚Äî Respuesta: `DetailedOrder`
- `GET /search/detailed/code/:code` ‚Äî Buscar por c√≥digo (contains) ‚Äî Respuesta: `DetailedOrder[]`
- `PATCH /:id` ‚Äî Actualizar ‚Äî Body: `UpdateOrderDto` ‚Äî Respuesta: `BaseApiResponse<Order>`
- `DELETE /remove/all` ‚Äî Desactivar m√∫ltiples ‚Äî Body: `DeleteOrdersDto` ‚Äî Respuesta: `BaseApiResponse<Order[]>`
- `PATCH /reactivate/all` ‚Äî Reactivar m√∫ltiples ‚Äî Body: `DeleteOrdersDto` ‚Äî Respuesta: `BaseApiResponse<Order[]>`
- `POST /:id/submit-draft` ‚Äî Confirmar borrador (DRAFT ‚Üí PENDING) y crear pago ‚Äî Body: `SubmitDraftOrderDto`
- `POST /:id/complete` ‚Äî Completar orden ‚Äî Respuesta: `BaseApiResponse<Order>`
- `POST /:id/cancel` ‚Äî Cancelar orden (y pagos PENDING/PROCESSING)
- `POST /:id/refund` ‚Äî Reembolsar orden (requiere pagos COMPLETED)

### Pagos (`/api/v1/payment`)
- `POST /` ‚Äî Crear pago ‚Äî Body: `CreatePaymentDto` ‚Äî Respuesta: `BaseApiResponse<Payment>`
- `GET /` ‚Äî Listar pagos ‚Äî Respuesta: `Payment[]`
- `GET /status/:status?type=...` ‚Äî Listar por estado y opcional tipo ‚Äî Respuesta: `{ payments, typeStats }`
- `GET /:id` ‚Äî Obtener por id ‚Äî Respuesta: `Payment`
- `PATCH /:id` ‚Äî Actualizar parcial ‚Äî Body: `UpdatePaymentDto`
- `DELETE /remove/all` ‚Äî Desactivar m√∫ltiples ‚Äî Body: `DeletePaymentsDto`
- `PATCH /reactivate/all` ‚Äî Reactivar m√∫ltiples ‚Äî Body: `{ ids: string[] }`
- `POST /:id/process` ‚Äî Procesar pago (PENDING ‚Üí PROCESSING) ‚Äî Body: `ProcessPaymentDto`
- `POST /:id/verify` ‚Äî Verificar pago (PROCESSING ‚Üí COMPLETED) ‚Äî Body: `VerifyPaymentDto`
- `POST /:id/reject` ‚Äî Rechazar pago (PROCESSING ‚Üí CANCELLED) ‚Äî Body: `RejectPaymentDto`
- `POST /:id/cancel` ‚Äî Cancelar pago (PENDING ‚Üí CANCELLED) ‚Äî Body: `CancelPaymentDto`
- `POST /:id/refund` ‚Äî Reembolsar pago ‚Äî Body: `RefundPaymentDto`

## üîí Seguridad y Autorizaci√≥n
- Decoradores: `@Auth()`, `@GetUser()`, `@GetUserBranch()`
- Filtro por sucursal en listados de √≥rdenes para roles administrativos
- Auditor√≠a en todas las operaciones de cambio de estado/creaci√≥n

## üîÑ Eventos de Dominio
- Enum `OrderEvents`: `order.completed`, `order.cancelled`, `order.failed`, `order.requires_attention`
- Emisi√≥n en casos de uso: completar, cancelar, reembolsar, verificar/rechazar pagos
- Payloads incluyen `order` y `metadata` contextual (p. ej., `paymentId`, raz√≥n, fechas)

## üìè Reglas y Validaciones de Negocio
- Orden DRAFT solo puede pasar a PENDING v√≠a submit; luego a COMPLETED/CANCELLED/REFUNDED seg√∫n flujo
- `RefundOrderUseCase`: requiere orden COMPLETED y pagos COMPLETED asociados
- `ProcessPaymentUseCase`: si m√©todo != CASH, requiere `voucherNumber`; valida monto contra `order.total`
- `VerifyPaymentUseCase`: PAYMENT PROCESSING ‚Üí COMPLETED y orden ‚Üí COMPLETED
- `Reject/Cancel Payment`: estados v√°lidos y propagaci√≥n de estado a la orden
- Reembolsos registran un pago adicional de tipo REFUND con monto negativo

## üßÆ Utilidades
- `PaymentCalculations`: totales por tipo, montos netos y m√©tricas por tipo (`getPaymentStats*`)

## üß™ Testing Recomendado
- Unit: casos de uso de cambio de estado (√≥rdenes y pagos), validaciones de monto/m√©todo
- Integration: repositorios con Prisma y transacciones/soft-delete
- E2E: endpoints de √≥rdenes y pagos incluyendo escenarios de eventos

## üö® Manejo de Errores
- Centralizado con `BaseErrorHandler`
- Mensajes espec√≠ficos:
  - `orderErrorMessages`: `notFound`, `invalidStatus`, `generatorNotFound`, etc.
  - `paymentErrorMessages`: `duplicatePayment`, `invalidAmount`, `paymentAlreadyProcessed`, etc.
- C√≥digos comunes: 400, 404, 409, 422, 500

## üîß Configuraci√≥n (opcional)
Variables sugeridas si se parametrizan reglas:
```env
ORDER_DEFAULT_CURRENCY=PEN
PAY_TAX_RATE=0.18
PAYMENT_REQUIRE_VOUCHER_FOR_NONCASH=true
```

## üîó Integraciones
- Billing: registra generadores de √≥rdenes (citas, recetas, ventas) y consume `OrderService`
- Inventory/Calendar: indirectas v√≠a metadatos y flujos de negocio
- Audit: auditor√≠a en todas las operaciones cr√≠ticas

---

Documentaci√≥n del m√≥dulo Pay - Sistema API Juan Pablo II
